<!DOCTYPE html>
<html>
<head>
  <style>body { margin: 0; font-family: sans-serif; }</style>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
  <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/customParseFormat.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/weekday.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/localeData.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/weekOfYear.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/weekYear.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/advancedFormat.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/quarterOfYear.js"></script>
  <script>
    dayjs.extend(window.dayjs_plugin_customParseFormat);
    dayjs.extend(window.dayjs_plugin_weekday);
    dayjs.extend(window.dayjs_plugin_localeData);
    dayjs.extend(window.dayjs_plugin_weekOfYear);
    dayjs.extend(window.dayjs_plugin_weekYear);
    dayjs.extend(window.dayjs_plugin_advancedFormat);
    dayjs.extend(window.dayjs_plugin_quarterOfYear);
  </script>
  <script src="https://unpkg.com/ant-design-vue@4/dist/antd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/ant-design-vue@4/dist/reset.css">
  <script src="https://unpkg.com/pinia@2/dist/pinia.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue3-sfc-loader/dist/vue3-sfc-loader.js"></script>
</head>
<body>
  <div id="app"></div>
  <script>
    const options = {
      moduleCache: {
        vue: window.Vue,
        'vue-router': window.VueRouter,
        'pinia': window.Pinia,
        'ant-design-vue': window.antd
      },
      async getFile(url) {
        // Request file content from parent
        return new Promise((resolve, reject) => {
          const id = Math.random().toString(36).slice(2)
          window.parent.postMessage({ type: 'getFile', id, filename: url }, '*')
          
          const handler = (e) => {
             if (e.data.type === 'fileContent' && e.data.id === id) {
               window.removeEventListener('message', handler)
               if (e.data.content === null) reject(new Error('File not found: ' + url))
               else resolve(e.data.content)
             }
          }
          window.addEventListener('message', handler)
        })
      },
      addStyle(textContent) {
        const style = document.createElement('style');
        style.textContent = textContent;
        const ref = document.head.getElementsByTagName('style')[0] || null;
        document.head.insertBefore(style, ref);
      },
    }

    const { loadModule } = window['vue3-sfc-loader'];

    let app = null;

    window.addEventListener('message', (event) => {
      if (event.data.type === 'reload') {
        if (app) app.unmount();
        document.getElementById('app').innerHTML = '';
        
        // Clear cache to ensure fresh reload
        if (options.moduleCache['/App.vue']) {
           delete options.moduleCache['/App.vue'];
        }
        
        loadModule('/App.vue', options).then(App => {
          app = window.Vue.createApp(App);
          if (window.antd) app.use(window.antd); // Register Ant Design Vue
          if (window.Pinia) app.use(window.Pinia.createPinia()); // Register Pinia
          
          // Create and use Router
          const router = window.VueRouter.createRouter({
            history: window.VueRouter.createWebHashHistory(),
            routes: []
          });
          app.use(router);

          app.mount('#app');
        }).catch(err => {
          console.error(err);
          document.getElementById('app').innerHTML = `<pre style="color:red">${err.message}</pre>`
        });
      }
    });
    
    // Initial load signal
    window.parent.postMessage({ type: 'sandboxReady' }, '*')
  </script>
</body>
</html>
